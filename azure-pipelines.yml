trigger:
- azure-pipelines

variables:
  CCACHE_DIR: $(Pipeline.Workspace)/ccache

jobs:
- job: Linux
  pool:
   vmImage: 'ubuntu-16.04'
  strategy:
    matrix:
      production:
        config: 'production --lfsc --cadical --cryptominisat --language-bindings=java'
        environment: ''
        installCheck: true
        cacheKey: 'production-gcc'
      debug:
        config: 'debug --lfsc --cadical --cryptominisat --symfpu --language-bindings=java --no-debug-symbols'
        environment: ''
        installCheck: false
        cacheKey: 'debug-gcc'
      debug_clang:
        config: 'debug --lfsc --cadical --cryptominisat --symfpu --language-bindings=java --no-debug-symbols'
        environment: 'CC=clang CXX=clang++'
        installCheck: false
        cacheKey: 'debug-clang'
#      debug_cln:
#        cvc4Config: 'debug --language-bindings=java --no-debug-symbols --gpl --cln'
#        cvc4ConfigEnv: ''
#        installCheck: false
  steps:
  - script: |
      sudo apt-get update
      sudo apt-get install -y \
        antlr3 \
        ccache \
        cmake \
        cxxtest \
        junit4 \
        libantlr3c-dev \
        libcln-dev \
        libgmp-dev \
        libhamcrest-java \
        openjdk-8-jdk \
        swig3.0
      echo "##vso[task.prependpath]/usr/lib/ccache"
    displayName: 'Install dependencies via apt-get'

  - task: CacheBeta@0
    inputs:
        key: $(Agent.OS) | $(cacheKey)
        path: $(CCACHE_DIR)
    displayName: ccache

# Note: Required for the new Python API
#  - script: sudo pip install -U cython
#    condition: eq(variables.needCython, true)
#    displayName: 'Install Cython'

  - script: |
      ./contrib/get-symfpu
      ./contrib/get-lfsc-checker
      ./contrib/get-cadical
      ./contrib/get-cryptominisat
    displayName: 'Setup dependencies'

  - script: $(environment) ./configure.sh $(config)
              --prefix=$(pwd)/build/install
              --unit-testing
    displayName: 'Configure CVC4'

  - script: make -j $(nproc)
    workingDirectory: 'build'
    displayName: 'Build CVC4'

  - script: make -j$(nproc) check ARGS='-LE regress[1-4]'
    env:
      CVC4_REGRESSION_ARGS: '--no-early-exit'
    workingDirectory: 'build'
    displayName: 'Run regression/unit tests'

  - script: ctest -j$(nproc) -L example
    workingDirectory: 'build'
    displayName: 'Run examples'

  - script: |
      make install -j$(nproc)
      echo "#include <cvc4/cvc4.h>" > install_check.cpp
      echo "int main() { CVC4::ExprManager em; return 0; }" >> install_check.cpp
      g++ -std=c++11 install_check.cpp -I install/include -L install/lib -lcvc4
    condition: eq(variables.installCheck, true)
    workingDirectory: 'build'
    displayName: 'Install Check'


    #- job: macOS
    #  pool:
    #   vmImage: 'macos-10.13'
    #  strategy:
    #    matrix:
    #      production:
    #        cvc4Config: ''
    #      production_clang:
    #        cvc4Config: ''
    #        cvc4ConfigEnv: 'CC=clang CXX=clang++'
    #      debug:
    #        cvc4Config: '-g'
    #      python3:
    #        needCython: true
    #        cvc4Config: '--python --py3'
    #  steps:
    #  - script: echo "##vso[task.setvariable variable=ncpus]$(sysctl -n hw.logicalcpu)"
    #    displayName: 'Determine number of CPUs'
    #
    #  - bash: |
    #      brew install ccache
    #      echo "##vso[task.prependpath]/usr/local/opt/ccache/libexec"
    #    displayName: 'Install ccache'
    #
    #  - task: CacheBeta@0
    #    inputs:
    #        key: $(Agent.OS)
    #        path: $(CCACHE_DIR)
    #    displayName: ccache
    #
    #  - script: sudo pip3 install cython
    #    condition: eq(variables.needCython, true)
    #    displayName: 'Install Cython'
    #
    #  - script: echo ""
    #    displayName: 'Setup dependencies'
    #
    #  - script: echo ""
    #    displayName: 'Configure CVC4'
    #
    #  - script: make -j $(ncpus)
    #    workingDirectory: 'build'
    #    displayName: 'Build CVC4'
    #
    #  - script: ctest -j$(ncpus) --output-on-failure
    #    workingDirectory: 'build'
    #    displayName: 'Run CTest'
